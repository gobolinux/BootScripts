#!/bin/bash

# GoboLinux Init Script
# Written by Hisham Muhammad

trap "" INT QUIT TSTP
umask 022

### Sourcing necessary files ###

source GoboPath
BootScriptsDir=/Programs/BootScripts/Current/
source ${goboSettings}/BootOptions
source ${BootScriptsDir}/Functions/BootScripts

### Variables ###

ForksDir=${goboVariable}/BootScripts
export PATH="$PATH":${goboTasks}:${goboSettings}/BootScripts
modescript="$1"

mount ${goboStatus} &> /dev/null
mount ${goboObjects} &> /dev/null
mountpoint -q /System/Kernel/Status  || mount --rbind ${goboStatus}  /System/Kernel/Status
mountpoint -q /System/Kernel/Devices || mount --rbind ${goboDevices} /System/Kernel/Devices
mountpoint -q /System/Kernel/Objects || mount --rbind ${goboObjects} /System/Kernel/Objects

cmdline=`cat ${goboStatus}/cmdline`" "
while [ "$cmdline" ]
do
   switch="${cmdline%% *}"
   key="${switch%%=*}"
   value="${switch#*=}"
   [ "$PREVLEVEL" = "N" -a "$key" = "Boot" ] && modescript="$value"
   [ "$key" = "BootTheme" ] && BootTheme="$value"
   cmdline="${cmdline#* }"
done

# Shortcircuit for LiveCD
[ "$modescript" = "LiveCD" ] && exec /bin/StartLiveCD

### Launch the actual scripts ###

theme="$BootScriptsDir/Themes/$BootTheme"
if ! [ -f "$theme" ]
then 
   echo "Theme $BootTheme not found. Reverting to failsafe."
   theme="$BootScriptsDir/Themes/Slack"
fi

ThemeClear() {
   ThemeInit
}

source "$theme"

ThemeInit
ThemeFile "$modescript"
source ${goboSettings}/BootScripts/"$modescript"
ThemeFinish "${goboSettings}/issue"
